name: Humanese Warden Cycle

on:
  schedule:
    - cron: "0 */10 * * *"   # every 10 hours
  workflow_dispatch: {}       # manual trigger

permissions:
  contents: write             # needed to commit & push reports

jobs:
  warden:
    runs-on: ubuntu-latest

    env:
      TARGET_URL: ${{ vars.TARGET_URL || 'http://localhost:3000' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install Playwright Chromium
        run: playwright install chromium --with-deps

      - name: Run Warden cycle (scan + health check + reports)
        id: warden
        run: python scripts/warden_logic.py
        # Non-zero exit means health check failed; we capture it and block push.
        continue-on-error: true

      - name: Commit and push reports (only on healthy run)
        if: steps.warden.outcome == 'success'
        run: |
          git config user.name  "Humanese Warden"
          git config user.email "warden@humanese.ai"
          git add reports/ || true
          if git diff --cached --quiet; then
            echo "No report changes to commit."
          else
            git commit -m "chore(warden): update reports [skip ci]"
            git push
          fi

      - name: Fail workflow when health check did not pass
        if: steps.warden.outcome != 'success'
        run: |
          echo "::error::Warden cycle failed (health check did not pass). Reports updated but changes were NOT pushed."
          exit 1

      # --------------------------------------------------------------------------
      # Optional SSH deploy â€“ only runs when the required secrets are present.
      # --------------------------------------------------------------------------
      - name: Deploy over SSH
        # Only runs when all three deploy secrets are provided.
        if: |
          steps.warden.outcome == 'success' &&
          secrets.DEPLOY_HOST &&
          secrets.DEPLOY_USER &&
          secrets.DEPLOY_SSH_KEY
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          KEY_FILE="$(mktemp)"
          printf '%s\n' "${{ secrets.DEPLOY_SSH_KEY }}" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          # Use accept-new instead of no to avoid silent MITM risk on repeat deploys.
          # On first connect the host key is accepted; on subsequent runs it is verified.
          ssh -i "$KEY_FILE" \
              -o StrictHostKeyChecking=accept-new \
              -o BatchMode=yes \
              "${DEPLOY_USER}@${DEPLOY_HOST}" \
              "cd /opt/humanese && git pull && npm install --production"
          rm -f "$KEY_FILE"
