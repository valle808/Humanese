name: Humanese Guardian Agent

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  deployment_status:

permissions:
  contents: write
  pull-requests: write
  issues: write
  deployments: write
  statuses: write
  checks: write
  actions: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    outputs:
      health_status: ${{ steps.run-checks.outputs.health_status }}
      needs_fix: ${{ steps.run-checks.outputs.needs_fix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run deep health checks
        id: run-checks
        run: bash scripts/guardian-agent/health-check.sh
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-fix:
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.needs_fix == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run auto-fix
        id: run-fix
        run: bash scripts/guardian-agent/auto-fix.sh
        env:
          HEALTH_STATUS: ${{ needs.health-check.outputs.health_status }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push fixes
        if: steps.run-fix.outputs.fixes_applied == 'true'
        run: |
          git config user.name "humanese-guardian[bot]"
          git config user.email "guardian@humanese.app"
          git add -A
          git diff --cached --quiet || git commit -m "fix(guardian): auto-heal detected issues [skip ci]"
          git push origin HEAD
