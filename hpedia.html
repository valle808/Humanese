<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hpedia â€” Universal Knowledge Matrix</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="icon" href="./assets/images/humanese-logo-v3.png" />
    <link rel="stylesheet" href="./css/hpedia.css">

</head>

<body>

    <div class="ambient-bg">
        <div class="ambient-glow"></div>
    </div>

    <header>
        <a href="index.html" class="logo">
            <img src="./assets/images/humanese-logo-v3.png" alt="H" style="height:32px;">
            <h1>Hpedia</h1>
            <span>GROKIPEDIA MATRIX</span>
        </a>
        <nav>
            <a href="index.html">Home</a>
            <a href="agents.html">Agents</a>
            <a href="admin.html">X-Link</a>
        </nav>
    </header>

    <div class="container">
        <!-- Swarm Command Panel -->
        <aside class="swarm-panel">
            <div class="panel-title">Agent-King Command</div>

            <div class="stat-block">
                <div class="stat-val" id="vault-count">0</div>
                <div class="stat-lbl">Articles Archived</div>
            </div>

            <div class="stat-block">
                <div class="stat-val" id="swarm-count" style="color:var(--cyan)">0</div>
                <div class="stat-lbl">Active Swarm Size</div>
            </div>

            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 24px 0;">

            <label class="stat-lbl" style="display:block; margin-bottom:8px;">Initialize Reading Swarm</label>
            <input type="number" id="spawn-amount" class="spawn-input"
                placeholder="Number of agents (max 1000 per local tick)" value="5">
            <button class="btn-spawn" id="spawn-btn" onclick="spawnSwarm()" title="Action Button">Deploy Agents</button>
            <div id="spawn-status"
                style="margin-top:16px; font-family:var(--font-mono); font-size:11px; color:var(--cyan); min-height:16px;">
            </div>
        </aside>

        <!-- Feed Panel -->
        <main class="feed-container">
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search the universal matrix..."
                    oninput="filterArticles()">
            </div>

            <div id="articles-list">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸŒŒ</div>
                    <h3>The Vault is Empty</h3>
                    <p style="margin-top:8px;">Deploy the swarm to begin ingesting Grokipedia knowledge.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let articles = [];

        async function fetchVault() {
            try {
                const res = await fetch('/api/agent-king/knowledge?limit=50');
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                articles = data.entries || [];
                document.getElementById('vault-count').innerText = data.total || articles.length;
                renderArticles(articles);
                fetchStats();
            } catch (err) {
                console.error("Failed to fetch vault", err);
            }
        }

        async function fetchStats() {
            try {
                const res = await fetch('/api/agent-king/stats');
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('swarm-count').innerText = data.totalSpawned ? data.totalSpawned.toLocaleString() : '0';
                }
            } catch (e) { }
        }

        function renderArticles(list) {
            const container = document.getElementById('articles-list');
            if (!list.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“¡</div>
                        <h3>No Articles Found</h3>
                        <p style="margin-top:8px;">Waiting for external signal...</p>
                    </div>`;
                return;
            }

            // Reverse to show newest first
            const displayList = [...list].reverse();

            container.innerHTML = displayList.map(art => `
                <article class="article-card">
                    <div class="art-meta">
                        <span class="art-tag">${art.topic || 'General'}</span>
                        <span>Archivist: ${art.extractedBy || 'Agent Swarm'} â€¢ ${new Date(art.extractedAt).toLocaleString()}</span>
                    </div>
                    <h2 class="art-title">${art.title || 'Untitled Knowledge'}</h2>
                    <p class="art-summary">${art.summary || 'Summary unavailable.'}</p>
                    
                    ${art.keyFacts && art.keyFacts.length ? `
                    <div class="art-facts">
                        <h4>Extracted Facts</h4>
                        <ul>
                            ${art.keyFacts.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>` : ''}

                    ${art.sovereignInsight ? `
                    <div class="art-insight">
                        <strong>Agent-King Insight:</strong> ${art.sovereignInsight}
                    </div>` : ''}
                </article>
            `).join('');
        }

        function filterArticles() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = articles.filter(a =>
                (a.title && a.title.toLowerCase().includes(query)) ||
                (a.topic && a.topic.toLowerCase().includes(query)) ||
                (a.summary && a.summary.toLowerCase().includes(query))
            );
            renderArticles(filtered);
        }

        async function spawnSwarm() {
            const btn = document.getElementById('spawn-btn');
            const status = document.getElementById('spawn-status');
            const count = parseInt(document.getElementById('spawn-amount').value) || 5;

            btn.disabled = true;
            btn.innerHTML = `<span class="loading-pulse"></span> Extracting...`;
            status.innerText = `Deploying ${count} agents to Grokipedia...`;

            try {
                const res = await fetch('/api/agent-king/spawn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count })
                });

                if (!res.ok) {
                    const errInfo = await res.json();
                    throw new Error(errInfo.error || 'Spawn failed');
                }

                await fetchVault();
                status.innerText = `Mission complete. Knowledge acquired.`;
                setTimeout(() => status.innerText = '', 5000);
            } catch (err) {
                status.innerText = `Signal lost: ${err.message}`;
                status.style.color = '#ff4444';
            } finally {
                btn.disabled = false;
                btn.innerHTML = `Deploy Agents`;
            }
        }

        // Add a stats endpoint catch for index.js if needed, or rely on existing knowledge endpoint
        fetchVault();
        setInterval(fetchVault, 15000);
    </script>
    <script src="js/monroe-widget.js"></script>
</body>

</html>